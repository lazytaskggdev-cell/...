<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Library TV</title>

<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

<style>
body{
    margin:0;
    font-family:Roboto,Arial,sans-serif;
    background:#000;
    color:#fff;
    overflow:hidden;
}

/* HEADER */

header{
    height:90px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 60px;
    font-size:32px;
    background:#111;
}

/* PLAYER */

.player{
    width:100%;
    background:#000;
    aspect-ratio:16/9;
    position:relative;
}

video{
    width:100%;
    height:100%;
}

/* TV CONTROLS */

.tv-controls{
    position:absolute;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:40px;
}

.tv-btn{
    padding:18px 34px;
    background:#222;
    border-radius:10px;
    font-size:24px;
    cursor:pointer;
}

.tv-btn:focus{
    outline:5px solid #1e90ff;
    background:#333;
}

/* CONTENT SECTION */

.section{
    padding:40px 60px;
}

.section h2{
    font-size:30px;
    margin-bottom:25px;
}

.row{
    display:flex;
    gap:25px;
    overflow-x:auto;
    scroll-behavior:smooth;
}

.card{
    min-width:360px;
    height:200px;
    background:#222;
    border-radius:12px;
    overflow:hidden;
    transition:.2s;
}

.card video{
    width:100%;
    height:100%;
    object-fit:cover;
}

.card:focus{
    outline:6px solid #1e90ff;
    transform:scale(1.08);
}
</style>
</head>

<body>

<header>
    <div>Media Library TV</div>
    <google-cast-launcher></google-cast-launcher>
</header>

<div class="player">
    <video id="videoPlayer"></video>

    <div class="tv-controls">
        <div class="tv-btn" tabindex="0" data-action="play">Play / Pause</div>
        <div class="tv-btn" tabindex="0" data-action="rewind">Rewind 10s</div>
        <div class="tv-btn" tabindex="0" data-action="forward">Forward 10s</div>
        <div class="tv-btn" tabindex="0" data-action="fullscreen">Fullscreen</div>
    </div>
</div>

<div class="section">
    <h2>Library</h2>
    <div class="row" id="row"></div>
</div>

<input type="file" id="fileInput" accept="video/*" hidden>

<script>
let db;
let videos=[];
let currentVideo=null;

const request=indexedDB.open("MediaLibraryTV",1);

request.onupgradeneeded=e=>{
    db=e.target.result;
    db.createObjectStore("videos",{keyPath:"name"});
};

request.onsuccess=e=>{
    db=e.target.result;
    loadVideos();
};

function saveVideo(video){
    const tx=db.transaction("videos","readwrite");
    tx.objectStore("videos").put(video);
}

function loadVideos(){
    const tx=db.transaction("videos","readonly");
    const getAll=tx.objectStore("videos").getAll();
    getAll.onsuccess=()=>{
        videos=getAll.result;
        renderRow();
    };
}

function renderRow(){
    const row=document.getElementById("row");
    row.innerHTML="";

    videos.forEach(v=>{
        const card=document.createElement("div");
        card.className="card";
        card.tabIndex=0;

        const vid=document.createElement("video");
        vid.src=v.data;
        vid.muted=true;

        card.appendChild(vid);

        card.addEventListener("click",()=>loadVideo(v));
        card.addEventListener("focus",()=>card.scrollIntoView({behavior:"smooth",inline:"center"}));

        row.appendChild(card);
    });
}

function loadVideo(v){
    const player=document.getElementById("videoPlayer");
    player.src=v.data;
    player.currentTime=v.progress||0;
    player.play();
    currentVideo=v;
}

const player=document.getElementById("videoPlayer");

player.ontimeupdate=()=>{
    if(currentVideo){
        currentVideo.progress=player.currentTime;
        saveVideo(currentVideo);
    }
};

/* TV CONTROL ACTIONS */

document.querySelectorAll(".tv-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
        const action=btn.dataset.action;

        if(action==="play"){
            if(player.paused) player.play();
            else player.pause();
        }

        if(action==="rewind"){
            player.currentTime-=10;
        }

        if(action==="forward"){
            player.currentTime+=10;
        }

        if(action==="fullscreen"){
            player.requestFullscreen();
        }
    });
});

/* D-PAD SUPPORT */

document.addEventListener("keydown",e=>{
    const focus=document.activeElement;

    if(e.key==="Enter"){
        focus.click();
    }

    if(e.key==="ArrowRight"){
        if(focus.nextElementSibling){
            focus.nextElementSibling.focus();
        }
    }

    if(e.key==="ArrowLeft"){
        if(focus.previousElementSibling){
            focus.previousElementSibling.focus();
        }
    }

    if(e.key==="ArrowDown"){
        document.querySelector(".tv-btn").focus();
    }

    if(e.key==="ArrowUp"){
        document.querySelector(".card")?.focus();
    }
});

/* FILE UPLOAD VIA REMOTE TRIGGER */

document.addEventListener("keydown",e=>{
    if(e.key==="u"){
        document.getElementById("fileInput").click();
    }
});

document.getElementById("fileInput").onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;

    const url=URL.createObjectURL(file);

    const videoObj={
        name:file.name,
        data:url,
        progress:0
    };

    videos.push(videoObj);
    saveVideo(videoObj);
    renderRow();
};

/* GOOGLE CAST */

window['__onGCastApiAvailable']=function(isAvailable){
    if(isAvailable){
        cast.framework.CastContext.getInstance().setOptions({
            receiverApplicationId:chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
            autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
    }
};

player.addEventListener("play",function(){
    if(currentVideo){
        const context=cast.framework.CastContext.getInstance();
        const session=context.getCurrentSession();
        if(session){
            const mediaInfo=new chrome.cast.media.MediaInfo(currentVideo.data,'video/mp4');
            const request=new chrome.cast.media.LoadRequest(mediaInfo);
            session.loadMedia(request);
        }
    }
});
</script>

</body>
</html>
